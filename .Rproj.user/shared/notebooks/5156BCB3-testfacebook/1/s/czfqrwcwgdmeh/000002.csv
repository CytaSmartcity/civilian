"0","#Facebook API correction"
"0","fbOAuth <- function(app_id, app_secret, extended_permissions=FALSE, legacy_permissions=FALSE, scope=NULL)"
"0","{"
"0","  ## getting callback URL"
"0","  full_url <- oauth_callback()"
"0","  full_url <- gsub(""(.*localhost:[0-9]{1,5}/).*"", x=full_url, replacement=""\\1"")"
"0","  message <- paste(""Copy and paste into Site URL on Facebook App Settings:"","
"0","                   full_url, ""\nWhen done, press any key to continue..."")"
"0","  ## prompting user to introduce callback URL in app page"
"0","  invisible(readline(message))"
"0","  ## a simplified version of the example in httr package"
"0","  facebook <- oauth_endpoint("
"0","    authorize = ""https://www.facebook.com/dialog/oauth"","
"0","    access = ""https://graph.facebook.com/oauth/access_token"") "
"0","  myapp <- oauth_app(""facebook"", app_id, app_secret)"
"0","  if (is.null(scope)) {"
"0","    if (extended_permissions==TRUE){"
"0","      scope <- c(""user_birthday"", ""user_hometown"", ""user_location"", ""user_relationships"","
"0","                 ""publish_actions"",""user_status"",""user_likes"")"
"0","    }"
"0","    else { scope <- c(""public_profile"", ""user_friends"")}"
"0","  "
"0","    if (legacy_permissions==TRUE) {"
"0","      scope <- c(scope, ""read_stream"")"
"0","    }"
"0","  }"
"0","  if (packageVersion('httr') < ""1.2""){"
"0","    stop(""Rfacebook requires httr version 1.2.0 or greater"")"
"0","  }"
"0","  ## with early httr versions"
"0","  if (packageVersion('httr') <= ""0.2""){"
"0","    facebook_token <- oauth2.0_token(facebook, myapp,"
"0","                                     scope=scope)"
"0","    fb_oauth <- sign_oauth2.0(facebook_token$access_token)"
"0","    if (GET(""https://graph.facebook.com/me"", config=fb_oauth)$status==200){"
"0","      message(""Authentication successful."")"
"0","    }"
"0","  }"
"0","  ## less early httr versions"
"0","  if (packageVersion('httr') > ""0.2"" & packageVersion('httr') <= ""0.6.1""){"
"0","    fb_oauth <- oauth2.0_token(facebook, myapp,"
"0","                               scope=scope, cache=FALSE) "
"0","    if (GET(""https://graph.facebook.com/me"", config(token=fb_oauth))$status==200){"
"0","      message(""Authentication successful."")"
"0","    } "
"0","  }"
"0","  ## httr version from 0.6 to 1.1"
"0","  if (packageVersion('httr') > ""0.6.1"" & packageVersion('httr') < ""1.2""){"
"0","    Sys.setenv(""HTTR_SERVER_PORT"" = ""1410/"")"
"0","    fb_oauth <- oauth2.0_token(facebook, myapp,"
"0","                               scope=scope, cache=FALSE)  "
"0","    if (GET(""https://graph.facebook.com/me"", config(token=fb_oauth))$status==200){"
"0","      message(""Authentication successful."")"
"0","    } "
"0","  }"
"0","  ## httr version after 1.2"
"0","  if (packageVersion('httr') >= ""1.2""){"
"0","    fb_oauth <- oauth2.0_token(facebook, myapp,"
"0","                               scope=scope, cache=FALSE)  "
"0","    if (GET(""https://graph.facebook.com/me"", config(token=fb_oauth))$status==200){"
"0","      message(""Authentication successful."")"
"0","    } "
"0","  }"
"0","  ## identifying API version of token"
"0","  error <- tryCatch(callAPI('https://graph.facebook.com/pablobarbera', fb_oauth),"
"0","                    error = function(e) e)"
"0","  if (inherits(error, 'error')){"
"0","    class(fb_oauth)[4] <- 'v2'"
"0","  }"
"0","  if (!inherits(error, 'error')){"
"0","    class(fb_oauth)[4] <- 'v1'"
"0","  }"
"0","  return(fb_oauth)"
"0","}"
